var BBValid={JsPath:BB.JSPATH+"util/valid/"};Object.extendJson(BBValid,{calendarJsUrl:BBValid.JsPath+"BBCalendar.js?v={version}",calendarCssUrl:BBValid.JsPath+"BBCalendar.css",calendarImg:null,getCalendarImg:function(){if(!BBValid.calendarImg){var A=BBValid.calendarImg=Dom.createElement("img",{src:BBValid.JsPath+"BBCalendar.gif",align:"absMiddle",className:"calendar-hdl-img"});A.style.cursor="pointer";}return BBValid.calendarImg;},_getElsByTagNames:function(D,F){var E=F.split(",");var G=[];for(var C=0;C<E.length;C++){var B=D.getElementsByTagName(E[C]);for(var A=0;A<B.length;A++){G.push(B[A]);}}return G;}});BBValid.chkNumber=function(B,F,D){if(!BBValid.chkMandatoryIfOk(null,B)){return false;}BBValid.dbc2sbcValue(B);var A=B.value;if(A==""){return BBValid.vldOkFun(B);}var G=B.getAttribute("errorStr");if(F==null){F=10;}if(D==null){D=0;}var I=null;if(D<1){if((/\D/).test(A)||A.length>F){I=(G||BBValid.MSGS.n_integer).format(1+new Array(F+1).join("0"));}}else{var H="^[0-9]{1,"+(F-D)+"}(\\.[0-9]{1,"+D+"})?$";if(!(new RegExp(H)).test(A)){I=(G||BBValid.MSGS.n_format).format((new Array(F-D+1)).join("X")+"."+(new Array(D+1)).join("X"));}}if((/^0[0-9]/).test(A)){var I=G||BBValid.MSGS.n_useless_zero;}if(I){BBValid.vldErrorFun(B,I);return false;}var C=B.getAttribute("maxValue");if(C&&(parseFloat(B.value,10)>C-0)){BBValid.vldErrorFun(B,(G||BBValid.MSGS.n_upper).format(B.value,C));return false;}var E=B.getAttribute("minValue");if(E&&parseFloat(B.value,10)<E-0){BBValid.vldErrorFun(B,(G||BBValid.MSGS.n_lower).format(B.value,E));return false;}return BBValid.vldOkFun(B);};BBValid.chkDate=function(H,B){B=B||this;if(!BBValid.chkMandatoryIfOk(null,B)){return false;}BBValid.dbc2sbcValue(B);var A=B.value;if(A==""){return BBValid.vldOkFun(B);}var I=B.getAttribute("errorStr");A=A.replace(/(^\D+)|(\D+$)/g,"").replace(/\D+/g,"/");if(!(/\D/).test(A)){if(A.length==8){A=A.substr(0,4)+"/"+A.substr(4,2)+"/"+A.substr(6,2);}}var D=new Date(A);var G=false;if(isNaN(D)){G=true;}else{var E=A.split(/\D+/ig);if(E.length<3||E[0].length!=4||E[2].length>2){G=true;}else{if(D.format()!=B.value){BBValid.setTextInputValue(B,D.format());}}}if(G){BBValid.vldErrorFun(B,I||BBValid.MSGS.d_format);return false;}var C=B.getAttribute("maxValue")||"2049/12/31";if(D>new Date(C.replace(/\D+/g,"/"))){BBValid.vldErrorFun(B,(I||BBValid.MSGS.d_upper).format(B.value,C));return false;}var F=B.getAttribute("minValue")||"1900/01/01";if(D<new Date(F.replace(/\D+/g,"/"))){BBValid.vldErrorFun(B,(I||BBValid.MSGS.d_lower).format(B.value,F));return false;}return BBValid.vldOkFun(B);};BBValid.chkDateRange=function(F,E){E=E||this;var D=E.getAttribute("errorStr");var A=E,C=E;if(E._dateBgn){A=E._dateBgn;}else{if(E._dateEnd){C=E._dateEnd;}else{var B=E.parentNode.getElementsByTagName("input");if(B[0]==E){C=B[1];}else{A=B[0];}}}if(BBValid.chkDate(0,E)){if(BBValid.chkDate(0,E==C?A:C)&&A.value!=""&&C.value!=""&&A.value>C.value){BBValid.vldErrorFun(A,D||BBValid.MSGS.daterange_begin);BBValid.vldErrorFun(C,D||BBValid.MSGS.daterange_end);return false;}else{return true;}}else{return false;}};BBValid.bindDateRange=function(A,B){A._dateEnd=B;B._dateBgn=A;A.onblur=B.onblur=BBValid.chkDateRange;};BBValid.chkRegExp=function(el,regStr,errorStr,ignoreDBC){el=el||this;if(!BBValid.chkMandatoryIfOk(null,el)){return false;}if(el.value==""){return BBValid.vldOkFun(el);}if(ignoreDBC||el.getAttribute("ignoreDBC")){BBValid.dbc2sbcValue(el);}var reg=regStr;if(typeof (regStr)!="object"){regStr=regStr||(el.getAttribute("dataType")&&el.getAttribute("dataType").replace(/^Reg-/ig,""));reg=eval(regStr);}reg.lastIndex=0;if(!reg.test(el.value)){BBValid.vldErrorFun(el,el.getAttribute("errorStr")||errorStr||BBValid.MSGS.reg);return false;}return BBValid.vldOkFun(el);};BBValid.chkMaxLength=function(D,B,C){B=B||this;if(!BBValid.chkMandatoryIfOk(null,B)){return false;}if(C==null){C=B.getAttribute("maxLength");}if(C==null){C=1024;}var A=B.value.length;if(A>C){BBValid.vldErrorFun(B,(B.getAttribute("errorStr")||BBValid.MSGS.text_longer).format(A,C));return false;}else{BBValid.vldOkFun(B);}return true;};BBValid.chkByteMaxLength=function(D,B,C){B=B||this;if(!BBValid.chkMandatoryIfOk(null,B)){return false;}if(C==null){C=B.getAttribute("maxLength");}if(C==null){C=1024;}var A=B.value.byteLen();if(A>C){BBValid.vldErrorFun(B,(B.getAttribute("errorStr")||BBValid.MSGS.bytelen_longer).format(A,C));return false;}else{BBValid.vldOkFun(B);}return true;};BBValid.chkReconfirm=function(B,A){A=A||this;if(!BBValid.chkMandatoryIfOk(null,A)){return false;}if(A.getAttribute("ignoreDBC")){BBValid.dbc2sbcValue(A);}var C=$(A.getAttribute("reconfirmFor"));if(A.value!=C.value){BBValid.vldErrorFun(A,A.getAttribute("errorStr")||BBValid.MSGS.reconfirm);return false;}else{return BBValid.vldOkFun(A);}};BBValid.chkIdNumber=function(F,D){D=D||this;if(!BBValid.chkMandatoryIfOk(null,D)){return false;}BBValid.dbc2sbcValue(D);if(D.value==""){return BBValid.vldOkFun(D);}var A=false;if((/^[0-9]{15}$/).test(D.value)){A=true;}else{if((/^[0-9]{17}[0-9xX]$/).test(D.value)){var H="1,0,x,9,8,7,6,5,4,3,2".split(",");var G="7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2".split(",");var C=D.value.toLowerCase().split("");var E=0;for(var B=0;B<17;B++){E+=G[B]*C[B];}A=(H[E%11]==C[17]);}}if(!A){BBValid.vldErrorFun(D,D.getAttribute("errorStr")||BBValid.MSGS.idnumber);return false;}return BBValid.vldOkFun(D);};BBValid.chkCnName=function(B,A){A=A||this;return BBValid.chkByteMaxLength(null,A,32)&&BBValid.chkRegExp(A,/^[\u4e00-\u9fa5a-zA-Z.\u3002\u2022]{2,32}$/,BBValid.MSGS.cnname);};BBValid.chkImgFile=function(D,B){B=B||this;if(B.value==""){return BBValid.vldOkFun(B);}var C=B.value,A=C.substring(C.lastIndexOf(".")+1).toLowerCase();if(C.length>4&&(A=="jpg"||A=="jpeg"||A=="png"||A=="gif"||A=="tif"||A=="bmp")){return BBValid.vldOkFun(B);}else{BBValid.vldErrorFun(B,(B.getAttribute("errorStr")||BBValid.MSGS.imgfile));return false;}};BBValid.chkMandatoryIfOk=function(C,B,A){A=A||"altStr";B=B||this;BBValid.trimValue(B);if(B.getAttribute(A)){if(B.value!=""||(B.tagName=="SELECT"&&(B.length==0||B.length<3&&B.options[B.length-1].value==""))){BBValid.vldOkFun(B);}}return true;};BBValid.chkMandatory=function(H,E,B){B=B||"altStr";E=E||this;var F=E.getAttribute(B);if(F){var A=false;var G="mandatoryInput";if(E.tagName=="SELECT"){A=(E.value!=""||E.length==0||(E.length<3&&E.options[E.length-1].value==""));G="mandatorySelect";}else{if(E.type=="checkbox"||E.type=="radio"){var D=document.getElementsByName(E.name);for(var C=0;C<D.length;C++){if(A=D[C].checked){break;}}G="mandatorySelect";}else{BBValid.trimValue(E);A=(E.value!="");if(E.type=="file"){G="mandatoryFile";}}}if(!A){BBValid.vldErrorFun(E,F.indexOf(" ")==0?F.substr(1):BBValid.MSGS[G].format(F));return false;}else{BBValid.vldOkFun(E);}}return true;};BBValid.bindMandatoryGroup=function(A){(A.el||A.els[0]).mandatoryGroup=A;};BBValid.bindPhoneEls=function(A){BBValid.bindMandatoryGroup({els:A.els,logic:"0 || (!1 && !2) ",altStr:A.altStr});BBValid.bindMandatoryGroup({els:[A.els[1],A.els[0],A.els[2]],logic:"0 || (!1 && !2) ",altStr:A.altStr});};BBValid._isValueEmpty=function(A){if(A.type=="checkbox"||A.type=="radio"){return A.checked;}return A.value.trim()!="";};BBValid.chkMandatoryGroup=function(e,el){el=el||this;var mg=el.mandatoryGroup;if(!mg){return true;}eval("var els=0;");els=mg.els;if(!els.length){return true;}var lgc=mg.logic;if(lgc=="all"||lgc=="any"){var ar=[];for(var i=0;i<els.length;i++){ar.push(i);}if(lgc=="all"){lgc=ar.join("&&");}else{lgc=ar.join("||");}}var chkIdxs=lgc.split(/\D+/ig);for(var i=0;i<chkIdxs.length;i++){BBValid.trimValue(els[chkIdxs[i]*1]);}var s="var r="+lgc.replace(/(\d+)/ig,"BBValid._isValueEmpty(els[$1])")+";";eval(s);if(!r){BBValid.vldErrorFun(el,mg.altStr||BBValid.MSGS.mandatoryGroup);return false;}else{BBValid.vldOkFun(el);}return true;};BBValid.chkDataType=function(B,A){A=A||this;if(A.getAttribute("dataType")&&A.onblur&&!A.onblur()){return false;}return true;};BBValid.getDateFromPopup=function(E,C){E=E||window.event;C=C||this;if(C.type!="text"){C=C.previousSibling;}window.latestDateInput=C;if(!window.latestDateDialog){var A=window.latestDateDialog=new LayerPopup({close:false,useIframe:true,header:false});var B='<iframe frameBorder=0 src="blank.html" id="calendarIfm" style="width:270px;height:220px;"/>';A.setContent(B);var D=$("calendarIfm").contentWindow;D.document.write("<html><head><link rel=stylesheet href='"+BBValid.calendarCssUrl+"' ></link></head><body ><div id='calendarPage' >Calendar</div></body><script language=javascript src='"+BBValid.calendarJsUrl+"' ></script></html>");D.document.close();}else{$("calendarIfm").contentWindow.initCalendar();}window.latestDateDialog.show(0,C.offsetHeight,270,null,C);};BBValid.chkEditorText=function(B,G,A,H){H=(H!=false);BBEditor.prepareToSubmit();var F=A.maxLength||2000;var E=A.minLength||5;var C=B.textarea;var I=C.value;if(A.isIgnoreTag!=false){I=I.replace(/<\/?[^>]+>/gi,"").replace(/&nbsp;/g," ").trim();}var D="";if(I.length>F){D=(A.longerMsg||BBValid.MSGS.editor_longer).format(F);}else{if(I.length<E){D=(A.shorterMsg||BBValid.MSGS.editor_shorter).format(E);}}BBValid.bindEm(C,G);BBValid.bindFocusEl(C,B);try{if(D){BBValid.vldErrorFun(C,D);if(H){B.focus();}return false;}else{BBValid.vldOkFun(C);return true;}}finally{}};BBValid.getCheckedNum=function(A){var D=0;var C=document.getElementsByName(A);for(var B=0;B<C.length;B++){if(C[B].checked){D++;}}return D;};BBValid.setTextInputValue=function(A,B){if(A.createTextRange){A.createTextRange().text=B;}else{A.value=B;}};BBValid.trimValue=function(B){var A=B.value.trim();if(A!=B.value){BBValid.setTextInputValue(B,A);}};BBValid.dbc2sbcValue=function(B){var A=B.value.replace(/[\uff01-\uff5e]/g,function(C){return String.fromCharCode(C.charCodeAt(0)-65248);}).replace(/\u3000/g," ").replace(/\u3002/g,".");if(A!=B.value){BBValid.setTextInputValue(B,A);}};BBValid.vldErrorFun=function(C,D,B){Dom.addClassName(C,"error");var A=BBValid._findEm(C);if(BBValid._needJamMsgEm){if(BBValid._latestMsgEm==A){return ;}else{BBValid._latestMsgEm=A;}}if(A){A.style.display="none";var E=Dom.nextSibling(A);if(!E||E.tagName!="EM"){E=Dom.createElement("em",{className:"error"});A.parentNode.insertBefore(E,A.nextSibling);}E.style.display="";if(E.innerHTML!=D){E.innerHTML=D;}}if(B){BBValid.focusErrorEl(C);}};BBValid.vldOkFun=function(B){Dom.removeClassName(B,"error");var A=BBValid._findEm(B);if(BBValid._needJamMsgEm){if(BBValid._latestMsgEm==A){return true;}}if(A){A.style.display="";var C=Dom.nextSibling(A);if(C&&C.tagName=="EM"){C.style.display="none";}}return true;};BBValid.bindEm=function(B,A){$(B)._vldEmEl=$(A);};BBValid._findEm=function(C){var B=C._vldEmEl;if(!B){var E=C.getAttribute("vldEmId");if(E){return $(E);}var D=C.parentNode;for(var A=0;A<4;A++){D=Dom.nextSibling(D);if(!D){break;}else{if(D.tagName=="EM"){return D;}}}}return B;};BBValid.attachAllVlds=function(C){C=C||document;var B=BBValid._getElsByTagNames(C,"input,textarea,select");for(var A=0;A<B.length;A++){BBValid.attachVld(B[A]);}};BBValid.attachVld=function(E){var C=E.getAttribute("dataType");if(E.readOnly||E.disabled||E.onblur){return ;}if(C==null){if(E.getAttribute("altStr")!=null&&E.type!="checkbox"&&E.type!="radio"){E.onblur=BBValid.chkMandatoryIfOk;}return ;}if((/^Reg-/i).test(C)){var D=C.replace(/^Reg-/i,"");E.onblur=function(){return BBValid.chkRegExp(this,D);};return ;}C=C.toLowerCase();if(C=="d"||C=="daterange"){if(E.nextSibling&&E.nextSibling.tagName=="IMG"){return ;}var B=BBValid.getCalendarImg().cloneNode(true);B.onclick=BBValid.getDateFromPopup;E.parentNode.insertBefore(B,E.nextSibling);}else{if((/^n((\d*)|(\d+\.\d+))?$/).test(C)){var A=C.replace(/n/ig,"").split(/\D/);E.onblur=new Function("return BBValid.chkNumber(this,"+A[0]+","+A[1]+")");}else{if(C=="uv"){}}}if(BBValid.DATACHKS[C]){E.onblur=BBValid.DATACHKS[C];}};BBValid.callChkWithMsgs=function(B){try{var A=BBValid.MSGS;BBValid.MSGS=B.msgs;return B.chkFun.apply(null,B.artArray);}finally{BBValid.MSGS=A;}};BBValid.chkAllEls=function(D,K,J){J=(J!=false);BBValid._needJamMsgEm=true;BBValid._latestMsgEm=1;try{var E=D.elements;var I=null;var G=null;for(var F=0;F<E.length;F++){var C=E[F];if(!C.getAttribute("forceVld")&&(C.disabled||C.readOnly||!C.offsetWidth)){continue;}if(!BBValid.chkMandatory(null,C)||!BBValid.chkMandatoryGroup(null,C)||!BBValid.chkDataType(null,C)||K&&!K(C,D)){if(!I){I=C;}G=C;}}if(I){if(J){BBValid.focusErrorEl(I);window.setTimeout(function(){if(!BBValid.chkMandatory(null,I)||!BBValid.chkMandatoryGroup(null,I)||!BBValid.chkDataType(null,I)||K&&!K(I,D)){}},10);}return false;}for(var F=0;F<E.length;F++){var C=E[F];if(C.type=="textarea"&&C.getAttribute("dataType")=="editor_text"&&BBEditor&&BBEditor.instance&&BBEditor.instance.textarea==C&&BBEditor.instance.container.offsetWidth){var B=BBValid._findEm(C);var A={isIgnoreTag:(C.getAttribute("isIgnoreTag")!="false"),maxLength:C.getAttribute("maxLength"),longerMsg:C.getAttribute("errorStr"),minLength:C.getAttribute("minLength"),shorterMsg:C.getAttribute("errorStr")};return BBValid.chkEditorText(BBEditor.instance,B,A,J);}}return true;}catch(H){}finally{BBValid._needJamMsgEm=false;}};BBValid.renderVldErrs=function(E){if(typeof (E)=="array"){E={errs:E};}var G=E.formEls||{};var A=E.errs;if(A.length){for(var B=0;B<A.length;B++){var D=A[B];var C=D.el||D.elName&&(G[D.elName]||document.getElementsByName(D.elName)[0]);var F=D.errMsg||drr.errCode&&(BBValid.SERVER_ERR_MSGS[drr.errCode]||BBValid.SERVER_ERR_MSGS.unknow);if(C){(D.renderErrFun||BBValid.vldErrorFun)(C,F,0==B&&E.needFocus);}else{(D.renderErrFun||window.alert)(F);}}}};BBValid.renderVld=function(C,D,A,B){if(D){BBValid.vldOkFun(C);}else{BBValid.vldErrorFun(C,A,B);}return D;};BBValid.resetVlds=function(C){var B=C.elements;for(var A=0;A<B.length;A++){el=B[A];if(el.disabled||el.readOnly||!el.offsetWidth){continue;}if(el.getAttribute("altStr")||el.getAttribute("dataType")||el.mandatoryGroup||el._vldEmEl||el.getAttribute("vldEmId")){BBValid.vldOkFun(el);}}};BBValid.chkEl=function(A){return BBValid.chkMandatory(null,A)&&BBValid.chkMandatoryGroup(null,A)&&BBValid.chkDataType(null,A);};BBValid.bindFocusEl=function(B,A){$(B)._vldFocusEl=$(A);};BBValid._findFocusEl=function(A){return(A.getAttribute("focusElId")&&$(A.getAttribute("focusElId")))||A._vldFocusEl||A;};BBValid.focusErrorEl=function(B){var A=BBValid._findFocusEl(B);try{B.focus();if(!B.tagName){return ;}BBEffect.shine4Error(B);B.select();}catch(C){}};BBValid.MSGS={mandatoryInput:"请填写{0}。",mandatorySelect:"请选择{0}。",mandatoryFile:"请上传{0}。",mandatoryGroup:"请检查您的输入。",n_integer:"请输入小于{0}的正整数。",n_format:'数字输入格式为"{0}"。',n_useless_zero:'数字前面好像有多余的"0"。',n_upper:"输入值(<b>{0}</b>)大于最大允许值(<b>{1}</b>)。",n_lower:"输入值(<b>{0}</b>)小于最小允许值(<b>{1}</b>)。",d_format:'日期输入格式为"YYYY-MM-DD"。',d_upper:"您所输入的日期(<b>{0}</b>)大于最大允许值(<b>{1}</b>)。",d_lower:"您所输入的日期(<b>{0}</b>)小于最小允许值(<b>{1}</b>)。",daterange_begin:"起始日期不能大于截止日期。",daterange_end:"截止日期不能小于起始日期。",text_longer:"字数太多，最多允许输入<b>{1}</b>字。",bytelen_longer:"字数太多，最多允许输入<b>{1}</b>字节。",editor_longer:"字数太多，最多允许输入<b>{0}</b>字。",editor_shorter:"字数太少，最少允许输入<b>{0}</b>字。",reconfirm:"两次输入不一致。",time:"请检查您输入的时间格式。",email:"请检查您输入的Email格式。",mobilecode:"请检查您输入的手机号码。",phonezone:"请检查您输入的电话区号。",phonecode:"请检查您输入的电话号码。",phoneext:"请检查您输入的电话分机号码。",phoneormobile:"请检查您输入的手机／小灵通号码。",zipcode:"请检查您输入的邮政编码。",idnumber:"请检查您输入的身份证号码，目前只支持15位或者18位。",bankcard:"请检查您输入的银行账号。",cnname:"请检查您输入的姓名。",verifycode:"请检查您输入的验证码。",imgfile:"请检查您选择的图片文件路径，只支持jpg、jpeg、png、gif、tif、bmp格式。",reg:"请检查您的输入。"};BBValid.SERVER_ERR_MSGS={special_chars:"特殊字符太多，导致字符串无法存入数据库。",bad_words:"内容里带有不当字词。",unknow:"不明原因错误。"};BBValid.DATACHKS={d:BBValid.chkDate,daterange:BBValid.chkDateRange,time:function(){return BBValid.chkRegExp(this,/^(([0-1][0-9])|(2[0-3])):[0-5][0-9]:[0-5][0-9]$/,BBValid.MSGS.time,true);},email:function(){return BBValid.chkRegExp(this,/^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/,BBValid.MSGS.email,true);},mobilecode:function(){return BBValid.chkRegExp(this,/^(13|15|18)[0-9]{9}$/,BBValid.MSGS.mobilecode,true);},phonezone:function(){return BBValid.chkRegExp(this,/^0[1-9][0-9]{1,2}$/,BBValid.MSGS.phonezone,true);},phonecode:function(){return BBValid.chkRegExp(this,/^[1-9][0-9]{6,7}$/,BBValid.MSGS.phonecode,true);},phoneext:function(){return BBValid.chkRegExp(this,/^[0-9]{1,6}$/,BBValid.MSGS.phoneext,true);},phoneormobile:function(){return BBValid.chkRegExp(this,/^(((13|15|18)[0-9]{9})|(0[0-9]{9,11})|([1-9][0-9]{6,7}))$/,BBValid.MSGS.phoneormobile,true);},zipcode:function(){return BBValid.chkRegExp(this,/^[0-9]{6}$/,BBValid.MSGS.zipcode,true);},idnumber:BBValid.chkIdNumber,bankcard:function(){return BBValid.chkRegExp(this,/^[0-9a-zA-Z]{10,24}$/,BBValid.MSGS.bankcard,true);},cnname:BBValid.chkCnName,verifycode:function(){return BBValid.chkRegExp(this,/^\w{4}$/,BBValid.MSGS.verifycode);},reconfirm:BBValid.chkReconfirm,text:BBValid.chkMaxLength,bytelen:BBValid.chkByteMaxLength,imgfile:BBValid.chkImgFile};